# 团餐菜单生成工具需求文档

## 项目概述
一个基于AI的团餐公司一周菜单生成工具，为食堂厨师长提供智能化的菜单规划服务。

## 核心功能

### 1. 用户管理系统
#### 注册功能
- **触发条件**：食堂ID首次访问
- **注册信息**：
  - 食堂名称
  - 登录密码
  - 午餐热菜数量（默认8个）
  - 午餐凉菜数量（默认3个）
  - 餐制类型：定价餐/自助餐（记录用，不影响生成逻辑）
  - 上传4个Excel历史菜单文件

#### 登录功能
- 食堂ID + 密码验证
- 确保不同食堂数据隔离

### 2. 菜单生成系统
#### 生成参数配置
**固定参数（注册时设置）：**
- 热菜数量
- 凉菜数量

**可选参数（每次生成时选择）：**
- **荤素搭配**：
  - 主荤个数（默认：热菜数量/3，向上取整）
  - 半荤个数（默认：热菜数量/3，向上取整）
  - 素菜个数（默认：热菜数量/3，向上取整）

- **人员配置**：
  - 宽裕/紧缺（默认：紧缺）

- **历史菜占比**：
  - 0%/30%/50%/70%（默认：30%）

- **设备紧缺情况**（多选）：
  - 蒸屉紧缺
  - 烤箱紧缺
  - 炒锅紧缺
  - 炖锅紧缺
  - 烧炉紧缺
  - 无紧缺（默认）

- **辣味要求**：
  - 不辣/微辣/中辣（默认：微辣）

- **风味多样性**：
  - 每餐风味不少于5种（可选，默认不选）

- **菜品做工比例**：
  - 现炒:一锅出:半成品
  - 1:1:1/1:0.5:0.5/0.5:1:0.5/0.5:0.5:1/无要求（默认：无要求）

- **原材料多样性**：
  - 不少于4种/不少于5种/不少于6种/无要求（默认：无要求）

#### AI生成逻辑
- **API**：Deepseek Chat API
- **参数**：temperature = 0.7
- **重试机制**：如果生成结果不符合数量要求，自动重试
- **进度显示**：生成过程中显示"菜单生成中..."

### 3. 结果展示与导出
#### 菜单展示格式
- **表格结构**：5列（周一至周五）× N行（热菜+凉菜总数）
- **菜品标识**：
  - 历史菜品标注"历史"
  - 显示菜品类型：主荤/半荤/素菜
- **布局**：热菜在上，凉菜在下

#### Excel导出功能
- **格式**：横轴为周一到周五，纵轴分为热菜和凉菜区域
- **一键下载**：直接保存到用户电脑

### 4. 历史记录管理
- **存储数量**：每个食堂最多保存4份最近生成的菜单
- **查看功能**：显示生成时间，可查看历史菜单内容
- **不支持**：基于历史菜单重新编辑或生成

## 技术架构

### 前端技术栈
- **框架**：Next.js (React + TypeScript)
- **UI组件**：Ant Design
- **构建工具**：Vite
- **Excel处理**：
  - 上传：react-dropzone + xlsx
  - 导出：xlsx

### 后端技术栈
- **框架**：Next.js API Routes
- **数据库**：SQLite + Prisma
- **API集成**：Deepseek Chat API
- **会话管理**：Next.js内置session管理

### 部署方案
- **平台**：Vercel
- **数据库**：SQLite文件存储

## 数据结构

### 用户数据
```json
{
  "canteenId": "食堂唯一标识",
  "canteenName": "食堂名称", 
  "password": "登录密码",
  "hotDishCount": 8,
  "coldDishCount": 3,
  "mealType": "定价餐/自助餐",
  "historicalMenus": ["4个Excel文件解析后的菜品列表"],
  "createdAt": "注册时间"
}
```

### 菜单数据
```json
{
  "menuId": "菜单唯一标识",
  "canteenId": "所属食堂",
  "weekMenu": {
    "monday": ["菜品列表"],
    "tuesday": ["菜品列表"],
    "wednesday": ["菜品列表"],
    "thursday": ["菜品列表"],
    "friday": ["菜品列表"]
  },
  "generationParams": "生成时的参数配置",
  "createdAt": "生成时间"
}
```

## AI Prompt规则体系

### 规则优先级（从高到低）
1. **基础数量要求**：热菜凉菜总数、主荤半荤素菜数量必须严格遵守
2. **设备限制**：设备紧缺必须严格遵守  
3. **安全性要求**：成本控制（避免一餐多个高成本食材）
4. **做工比例要求**：在满足设备限制前提下尽量满足
5. **其他多样性要求**：风味、原材料、刀工等

### 参数映射规则
```json
{
  "设备要求": {
    "蒸屉": "蒸屉紧缺，不要出现蒸菜",
    "烤箱": "烤箱紧缺，不要出现烤菜", 
    "炒锅": "炒锅紧缺，出现炒菜不超过(<=)2道",
    "炖锅": "炖锅紧缺，不要出现炖菜",
    "烧炉": "烧炉紧缺，不要出现烧菜",
    "无": "所有烹饪设备均充足，蒸屉、烤箱、砂锅、炖锅、烧炉的使用注重均衡协调"
  },
  "人员配置": {
    "紧缺": "厨师人手紧缺，需要减少整体刀工复杂度，复杂刀工菜不超过20%",
    "宽裕": "厨师人手宽裕，可以出20-33%复杂刀工菜品以体现技术"
  },
  "辣味要求": {
    "不辣": "不要出现辣菜",
    "微辣": "微辣，辣菜在总数量占比10-20%", 
    "中辣": "中辣，辣菜在总数量占比20-30%"
  },
  "风味多样性": {
    "true": "在酸、甜、苦、辣、咸、鲜、麻、香、清淡9种风味之中，每餐出现风味不少于5种",
    "false": "无要求"
  },
  "原材料多样性": {
    "4种": "一餐出品的原材料不少于4种",
    "5种": "一餐出品的原材料不少于5种", 
    "6种": "一餐出品的原材料不少于6种",
    "无要求": ""
  },
  "刀工复杂性": {
    "人员紧缺": "切丝/丁/片的菜品不超过10%",
    "人员充足": "切丝/丁/片的菜品占比10%-30%"
  }
}
```

### 核心约束条件
1. **设备可实现性**：根据设备紧缺情况严格限制烹饪方式
2. **成本控制**：一餐避免重复出现高成本食材/菜品，如水产品、牛羊肉
3. **食材多样性**：一餐内，主要食材不得重复
4. **菜品做工均衡**：按比例要求分配现炒、一锅出、半成品
5. **烹饪方式多样性**：每周菜单必须出现炒、熘、蒸、烧、烤、炖、煎、烹8种烹饪方法中的至少六种
6. **口感多样性**：一餐不要出现超过两个勾芡菜

### 菜品分类定义
- **主荤菜**：以肉类/海鲜为主要食材，体现"硬菜"感觉的菜品（如可乐鸡翅、土豆炖牛肉）
- **半荤菜**：荤素搭配的菜品（如青笋炒肉片、宫保鸡丁）
- **素菜**：纯素食或以蔬菜为主的菜品
- **凉菜**：不区分荤素，一般以素食为主控制成本

## Excel处理方案

### 上传处理（方案A - 智能解析）
1. **自动识别**：系统自动识别Excel中的菜名列
2. **预览确认**：用户上传后可预览解析结果
3. **手动调整**：支持用户确认或调整解析结果
4. **格式兼容**：支持常见格式（纯菜名列表、带分类表格等）

### 历史菜单存储
- 解析后的菜品数据存储为JSON格式
- 与食堂ID关联存储
- 用于AI生成时的风格参考

## 项目配置

### API配置
- **Deepseek API Key**：sk-b74e7f38bf77468d8076e64db390155a
- **模型**：deepseek-chat
- **Temperature**：0.7

### 数据库配置
- **类型**：SQLite
- **ORM**：Prisma
- **存储位置**：项目根目录

### 部署配置
- **平台**：Vercel
- **环境变量**：API密钥等敏感信息
- **域名**：待定

## 开发优先级

### 第一阶段：核心功能
1. 用户注册/登录系统
2. Excel上传和解析
3. 基础菜单生成功能
4. 结果展示和Excel导出

### 第二阶段：优化功能  
1. 历史记录管理
2. 参数配置优化
3. 错误处理和重试机制
4. 用户体验优化

### 可选功能（如实现简单可加入）
1. 菜单编辑功能
2. 更多导出格式
3. 数据统计分析

## 注意事项

1. **安全性**：API密钥已在对话中暴露，部署前需重新生成
2. **数据隔离**：确保不同食堂之间数据完全隔离
3. **错误处理**：AI生成失败时的友好提示和重试机制
4. **性能优化**：大量用户时的并发处理
5. **成本控制**：监控API调用频率和成本
