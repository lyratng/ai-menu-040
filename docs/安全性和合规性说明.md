# 团餐菜单生成工具 - 安全性和合规性说明

## 📖 概述

本文档详细说明了团餐菜单生成工具在数据安全、隐私保护、合规性等方面的设计和实施措施。我们严格遵循行业最佳实践，确保用户数据安全和系统稳定运行。

---

## 🔐 数据安全

### 密码安全

#### 加密算法
- **算法选择**：bcrypt（行业标准）
- **成本因子**：12（约100ms计算时间）
- **盐值生成**：每次加密自动生成随机盐值
- **存储格式**：哈希值，永不存储明文密码

```typescript
// 密码加密示例
const hashedPassword = await bcrypt.hash(password, 12)
// 结果: $2b$12$randomSalt.hashedPasswordValue

// 密码验证
const isValid = await bcrypt.compare(inputPassword, storedHash)
```

#### 密码策略
- **最小长度**：6位字符
- **复杂度要求**：建议包含字母和数字
- **安全建议**：不强制但推荐使用强密码
- **密码重置**：目前需联系技术支持

### 用户认证

#### JWT Token安全
```typescript
// Token配置
const tokenConfig = {
  algorithm: 'HS256',           // HMAC-SHA256算法
  expiresIn: '24h',            // 24小时过期
  issuer: 'ai-menu.tech',      // 发行者标识
  secret: process.env.NEXTAUTH_SECRET  // 密钥（环境变量）
}
```

#### 会话管理
- **存储方式**：HTTP-Only Cookie（防XSS攻击）
- **传输安全**：仅通过HTTPS传输
- **自动过期**：24小时后需重新登录
- **安全标志**：Secure、SameSite=Strict

### 数据传输安全

#### HTTPS加密
```
- 传输协议：TLS 1.2+
- 证书类型：Let's Encrypt（免费SSL）
- 加密强度：256位AES加密
- 证书管理：Vercel自动续期
```

#### API安全
- **认证要求**：所有敏感API需JWT验证
- **请求验证**：参数类型检查和数据验证
- **错误处理**：不暴露敏感系统信息
- **频率限制**：防止暴力攻击

---

## 🛡 数据隐私保护

### 数据分类

#### 敏感数据
- **用户凭证**：食堂名称、密码哈希
- **业务数据**：历史菜单、生成参数
- **系统数据**：用户会话、访问日志

#### 数据处理原则
1. **最小化原则**：只收集必要的业务数据
2. **目的限制**：数据仅用于菜单生成服务
3. **存储限制**：自动清理过期数据
4. **访问控制**：严格的权限管理

### 数据隔离

#### 多租户隔离
```typescript
// 所有查询都必须包含食堂ID过滤
const menus = await prisma.menu.findMany({
  where: { 
    canteenId: currentUser.canteenId  // 强制数据隔离
  }
})

// 权限验证示例
if (decoded.canteenId !== requestCanteenId) {
  return NextResponse.json(
    { error: '无权限操作此食堂' },
    { status: 403 }
  )
}
```

#### 数据访问控制
- **横向隔离**：食堂间数据完全隔离
- **纵向控制**：基于角色的访问权限
- **审计日志**：记录关键数据访问
- **自动清理**：定期清理历史记录

### 第三方服务

#### AI服务安全
- **服务提供商**：Deepseek（国内AI服务商）
- **数据传输**：HTTPS加密传输
- **数据存储**：AI服务商不存储用户数据
- **API密钥**：环境变量存储，定期更换

```typescript
// API调用安全配置
const aiResponse = await fetch('https://api.deepseek.com/chat/completions', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${process.env.DEEPSEEK_API_KEY}`,  // 安全的密钥管理
  },
  body: JSON.stringify({
    model: 'deepseek-chat',
    messages: [{ role: 'user', content: prompt }],
    temperature: 0.7,
    max_tokens: 4000,
  }),
})
```

---

## 📋 合规性要求

### 数据保护法规

#### 国内法规遵循
- **《网络安全法》**：数据安全保护义务
- **《数据安全法》**：数据分类分级保护
- **《个人信息保护法》**：个人信息处理规范
- **《关键信息基础设施安全保护条例》**：基础设施安全

#### 具体措施
1. **数据分类**：按敏感级别分类管理
2. **访问控制**：最小权限原则
3. **安全审计**：定期安全评估
4. **事件响应**：安全事件处理流程

### 行业标准

#### 信息安全管理
- **参考标准**：ISO 27001信息安全管理体系
- **安全评估**：定期漏洞扫描和渗透测试
- **人员培训**：开发团队安全意识培训
- **文档管理**：安全相关文档版本控制

#### 开发安全
- **代码审查**：所有代码变更需安全审查
- **依赖管理**：定期更新和安全扫描
- **测试覆盖**：包含安全测试用例
- **部署安全**：生产环境安全配置

---

## 🔍 安全监控

### 实时监控

#### 系统安全监控
```typescript
// 异常登录检测
const loginAttempts = await redis.get(`login:${canteenName}`)
if (loginAttempts > 5) {
  return NextResponse.json(
    { error: '登录尝试过多，请稍后重试' },
    { status: 429 }
  )
}

// API调用频率监控
const apiCalls = await redis.get(`api:${canteenId}`)
if (apiCalls > 100) {  // 每小时限制
  return NextResponse.json(
    { error: 'API调用频率过高' },
    { status: 429 }
  )
}
```

#### 安全日志记录
- **登录活动**：成功/失败登录记录
- **数据访问**：敏感数据访问日志
- **API调用**：异常API调用监控
- **系统错误**：安全相关错误告警

### 威胁检测

#### 常见攻击防护
1. **SQL注入**：使用Prisma ORM，参数化查询
2. **XSS攻击**：HTTP-Only Cookie，内容安全策略
3. **CSRF攻击**：SameSite Cookie，Token验证
4. **暴力破解**：登录频率限制，账户锁定

```typescript
// 输入验证示例
const validateInput = (input: string) => {
  // 防止SQL注入
  if (input.includes(';') || input.includes('--')) {
    throw new Error('非法输入')
  }
  
  // 防止XSS
  return input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
}

// 内容安全策略
const cspHeader = `
  default-src 'self';
  script-src 'self' 'unsafe-inline';
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: https:;
  connect-src 'self' https://api.deepseek.com;
`
```

---

## 🚨 事件响应

### 安全事件分类

#### 事件级别
- **低级**：单个用户登录失败
- **中级**：异常API调用模式
- **高级**：数据泄露风险
- **严重**：系统入侵迹象

#### 响应流程
1. **事件发现**：自动监控 + 人工报告
2. **初步评估**：确定事件级别和影响范围
3. **应急响应**：隔离威胁，保护数据
4. **调查分析**：确定根本原因
5. **恢复操作**：系统恢复和加固
6. **事后总结**：改进安全措施

### 数据泄露应对

#### 预防措施
- **数据加密**：敏感数据加密存储
- **访问控制**：最小权限原则
- **网络隔离**：数据库网络隔离
- **备份安全**：加密备份存储

#### 应急预案
```bash
# 数据泄露应急处理步骤
1. 立即隔离受影响系统
2. 评估泄露数据范围和敏感程度
3. 通知相关用户和监管部门
4. 修复安全漏洞
5. 加强监控措施
6. 制定防范计划
```

---

## 🔧 安全配置

### 环境变量安全

#### 生产环境配置
```bash
# 数据库连接（使用连接池）
DATABASE_URL="postgresql://user:password@host:5432/db?connection_limit=10&pool_timeout=20"

# JWT密钥（强随机字符串）
NEXTAUTH_SECRET="your-super-secret-256-bit-key-here"

# AI API密钥（定期轮换）
DEEPSEEK_API_KEY="sk-your-production-api-key"

# 环境标识
NODE_ENV="production"
```

#### 密钥管理
- **生成要求**：使用密码学安全的随机数生成器
- **存储安全**：环境变量，不提交到代码库
- **访问控制**：只有运维人员有访问权限
- **定期轮换**：建议每6个月更换一次

### 服务器安全

#### Vercel平台安全
- **基础设施**：AWS/Google Cloud安全基础设施
- **网络安全**：DDoS防护，WAF保护
- **证书管理**：自动SSL证书管理
- **访问控制**：基于角色的团队访问

#### 自建服务器安全（如使用阿里云）
```bash
# 防火墙配置
ufw allow 22/tcp     # SSH
ufw allow 80/tcp     # HTTP
ufw allow 443/tcp    # HTTPS
ufw deny 3000/tcp    # 禁止直接访问应用端口

# 系统更新
apt update && apt upgrade -y

# 日志监控
tail -f /var/log/nginx/access.log | grep "suspicious"
```

---

## 📊 安全指标

### 关键指标监控

#### 系统安全指标
| 指标名称 | 目标值 | 监控频率 | 告警阈值 |
|---------|--------|----------|----------|
| 登录成功率 | >95% | 实时 | <90% |
| API响应时间 | <2s | 实时 | >5s |
| 错误率 | <1% | 实时 | >5% |
| 数据库连接数 | <80% | 5分钟 | >90% |

#### 安全事件统计
- **登录失败次数**：每日统计
- **异常API调用**：实时监控
- **系统错误数量**：每小时统计
- **安全补丁状态**：每周检查

### 安全评估

#### 定期评估
- **漏洞扫描**：每月进行自动化扫描
- **渗透测试**：每季度委托专业机构
- **代码审计**：每次重大更新前
- **依赖检查**：每周检查第三方依赖

#### 评估工具
```bash
# 依赖漏洞扫描
npm audit

# 代码质量检查
npx eslint src/ --ext .ts,.tsx

# 类型检查
npx tsc --noEmit

# 安全规则检查
npx semgrep --config=security src/
```

---

## 📚 安全最佳实践

### 开发安全

#### 代码安全
```typescript
// 1. 输入验证
const validateCanteenName = (name: string) => {
  if (!name || name.length < 2 || name.length > 50) {
    throw new Error('食堂名称长度必须在2-50字符之间')
  }
  // 防止特殊字符注入
  if (!/^[\u4e00-\u9fa5a-zA-Z0-9\s]+$/.test(name)) {
    throw new Error('食堂名称包含非法字符')
  }
  return name
}

// 2. 错误处理
try {
  const result = await riskyOperation()
  return result
} catch (error) {
  // 不暴露系统内部信息
  console.error('Internal error:', error)
  return { error: '系统错误，请稍后重试' }
}

// 3. 权限检查
const checkPermission = (userCanteenId: string, targetCanteenId: string) => {
  if (userCanteenId !== targetCanteenId) {
    throw new Error('权限不足')
  }
}
```

#### 配置安全
```typescript
// 1. 环境变量验证
const requiredEnvVars = [
  'DATABASE_URL',
  'NEXTAUTH_SECRET',
  'DEEPSEEK_API_KEY'
]

requiredEnvVars.forEach(envVar => {
  if (!process.env[envVar]) {
    throw new Error(`Missing required environment variable: ${envVar}`)
  }
})

// 2. 生产环境配置
if (process.env.NODE_ENV === 'production') {
  // 禁用调试信息
  console.debug = () => {}
  
  // 启用安全头
  app.use(helmet({
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        styleSrc: ["'self'", "'unsafe-inline'"],
        scriptSrc: ["'self'"],
        imgSrc: ["'self'", "data:", "https:"],
      },
    },
  }))
}
```

### 运维安全

#### 访问控制
- **最小权限原则**：每个角色只授予必要权限
- **双因子认证**：生产环境访问需2FA
- **访问审计**：记录所有管理员操作
- **定期审查**：季度权限审查和清理

#### 数据保护
```bash
# 数据库备份加密
pg_dump $DATABASE_URL | gpg --cipher-algo AES256 --compress-algo 1 --symmetric --output backup.sql.gpg

# 日志脱敏
sed 's/password=[^&]*/password=****/g' access.log > sanitized.log

# 定期清理
find /tmp -name "*.log" -mtime +7 -delete
```

---

## 📞 安全联系方式

### 安全问题报告

#### 联系渠道
- **安全邮箱**：security@ai-menu.tech
- **紧急联系**：技术负责人微信
- **响应时间**：24小时内响应

#### 报告格式
```
标题：[安全问题] 简要描述
内容：
1. 问题描述
2. 复现步骤
3. 影响评估
4. 建议措施
```

### 安全更新通知

#### 通知机制
- **重要更新**：邮件通知所有用户
- **安全补丁**：系统自动推送
- **升级建议**：定期发布安全建议

---

## 📋 合规检查清单

### 部署前检查

- [ ] 所有密码已加密存储
- [ ] JWT密钥已设置且足够复杂
- [ ] HTTPS已启用且证书有效
- [ ] 数据库连接已加密
- [ ] API密钥已安全存储
- [ ] 错误信息不暴露敏感信息
- [ ] 输入验证已实施
- [ ] 权限控制已配置
- [ ] 日志记录已启用
- [ ] 备份策略已制定

### 运行时检查

- [ ] 监控告警正常工作
- [ ] 安全日志正常记录
- [ ] 访问控制正常工作
- [ ] 数据隔离有效
- [ ] API频率限制生效
- [ ] 错误处理正确
- [ ] 系统性能正常
- [ ] 备份正常进行

---

