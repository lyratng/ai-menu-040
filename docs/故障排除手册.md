# 团餐菜单生成工具 - 故障排除手册

## 📖 概述

本手册为系统运维人员和技术支持团队提供常见问题的诊断和解决方案。按问题严重程度和影响范围分类，提供系统化的排障流程。

---

## 🚨 紧急故障处理

### 系统完全不可访问

#### 症状表现
- 网站打不开，显示404或502错误
- 所有用户无法访问系统
- Vercel控制台显示部署失败

#### 紧急处理步骤
```bash
# 1. 检查Vercel部署状态
vercel ls
vercel logs --follow

# 2. 检查最近的部署
vercel deployments

# 3. 如需紧急回滚
vercel rollback [deployment-url]

# 4. 或重新部署
vercel --prod
```

#### 常见原因及解决方案

**原因1：构建失败**
```bash
# 检查构建日志
vercel logs

# 常见构建错误：
# - 依赖安装失败：检查package.json
# - TypeScript错误：修复类型错误
# - 环境变量缺失：补充必要的环境变量
```

**原因2：数据库连接失败**
```bash
# 测试数据库连接
npx prisma db push --preview-feature

# 检查DATABASE_URL是否正确
echo $DATABASE_URL

# 重新生成Prisma客户端
npx prisma generate
```

**原因3：环境变量问题**
```bash
# 检查关键环境变量
vercel env ls

# 必需的环境变量：
# - DATABASE_URL
# - NEXTAUTH_SECRET  
# - DEEPSEEK_API_KEY
# - NODE_ENV
```

### 数据库连接问题

#### 症状表现
- 用户无法登录
- 菜单生成失败
- 系统显示数据库错误

#### 诊断步骤
```bash
# 1. 检查数据库服务状态
pg_isready -h your-db-host -p 5432

# 2. 测试连接
psql $DATABASE_URL -c "SELECT 1;"

# 3. 检查连接池状态
# 在应用日志中查找连接池警告

# 4. 验证Prisma配置
npx prisma validate
```

#### 解决方案
```bash
# 方案1：重启数据库连接池
# Vercel平台会自动处理，稍等片刻

# 方案2：检查数据库配置
# 确认DATABASE_URL格式正确
# postgresql://user:password@host:port/database

# 方案3：重新部署应用
vercel --prod

# 方案4：数据库重置（仅限开发环境）
npx prisma migrate reset
```

---

## ⚠️ 常见业务问题

### 用户无法登录

#### 问题分析流程
```
1. 确认用户输入信息
   ↓
2. 检查食堂是否存在
   ↓  
3. 验证密码正确性
   ↓
4. 检查JWT配置
   ↓
5. 查看系统日志
```

#### 诊断命令
```bash
# 1. 查看登录相关日志
vercel logs | grep "login"

# 2. 检查JWT密钥
echo $NEXTAUTH_SECRET

# 3. 测试数据库查询
npx prisma studio
# 在Studio中查询特定食堂记录
```

#### 解决方案

**情况1：用户不存在**
```sql
-- 查询用户是否存在
SELECT canteenName FROM canteens WHERE canteenName = 'xxx';

-- 如果用户不存在，需要重新注册
```

**情况2：密码错误**
```typescript
// 密码重置流程（需要数据库直接操作）
const bcrypt = require('bcryptjs')
const newPassword = 'new_password'
const hashedPassword = await bcrypt.hash(newPassword, 12)

// 在数据库中更新密码
UPDATE canteens SET password = 'hashedPassword' WHERE canteenName = 'xxx';
```

**情况3：JWT配置问题**
```bash
# 检查JWT密钥是否设置
if [ -z "$NEXTAUTH_SECRET" ]; then
  echo "JWT密钥未设置"
fi

# 重新生成JWT密钥
openssl rand -base64 32
```

### 菜单生成失败

#### 问题分类

**类型1：API调用失败**
```bash
# 症状：显示"菜单生成失败，请稍后重试"
# 检查AI API状态
curl -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
     https://api.deepseek.com/models

# 检查API余额
# 登录Deepseek控制台查看账户状态
```

**类型2：解析失败**
```bash
# 症状：生成过程卡住或返回格式错误
# 查看详细日志
vercel logs | grep "parse"

# 检查AI返回内容格式
# 在generateMenu API中添加详细日志
```

**类型3：参数错误**
```typescript
// 检查参数验证逻辑
const validateParams = (params: GenerationParams) => {
  if (params.mainMeatCount + params.halfMeatCount + params.vegetarianCount !== totalHotDishes) {
    throw new Error('荤素菜数量配置错误')
  }
}
```

#### 解决步骤
```bash
# 1. 检查AI API密钥
curl -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
     https://api.deepseek.com/chat/completions \
     -d '{"model":"deepseek-chat","messages":[{"role":"user","content":"test"}]}'

# 2. 验证参数配置
# 确保荤素菜数量总和等于热菜总数

# 3. 检查历史菜单数据
# 确保historicalMenus字段格式正确

# 4. 临时绕过方案
# 降低历史菜占比，简化生成参数
```

### Excel导出问题

#### 常见问题

**问题1：导出文件为空**
```typescript
// 检查数据是否存在
console.log('WeekMenu data:', weekMenu)
console.log('Canteen info:', canteenInfo)

// 确保数据格式正确
if (!weekMenu || !canteenInfo) {
  console.error('数据缺失，无法导出')
  return
}
```

**问题2：文件名乱码**
```typescript
// 文件名处理
const fileName = `${canteenInfo.canteenName}_菜单_${new Date().toISOString().split('T')[0]}.xlsx`
// 确保文件名不包含特殊字符
const safeFileName = fileName.replace(/[<>:"/\\|?*]/g, '_')
```

**问题3：Excel格式问题**
```typescript
// 检查XLSX库版本
npm list xlsx

// 重新安装XLSX库
npm install xlsx@latest
```

---

## 🔧 性能问题排查

### 响应速度慢

#### 性能监控
```bash
# 1. 检查Vercel Functions性能
vercel logs | grep "Duration"

# 2. 分析响应时间
curl -w "@curl-format.txt" -o /dev/null -s "https://ai-menu.tech/api/auth/me"

# curl-format.txt内容：
time_namelookup:  %{time_namelookup}\n
time_connect:     %{time_connect}\n
time_total:       %{time_total}\n
```

#### 性能瓶颈分析

**数据库查询慢**
```sql
-- 检查慢查询
SELECT query, mean_time, calls 
FROM pg_stat_statements 
WHERE mean_time > 1000 
ORDER BY mean_time DESC;

-- 优化查询索引
CREATE INDEX IF NOT EXISTS idx_menus_canteen_created 
ON menus(canteenId, createdAt DESC);
```

**AI API调用慢**
```bash
# 测试AI API响应时间
time curl -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{"model":"deepseek-chat","messages":[{"role":"user","content":"测试"}]}' \
          https://api.deepseek.com/chat/completions
```

**前端资源加载慢**
```bash
# 检查资源大小
du -sh public/*

# 分析bundle大小
npx next build --analyze

# 优化建议：
# 1. 启用gzip压缩
# 2. 优化图片格式
# 3. 代码分割
```

### 内存使用过高

#### 监控内存使用
```bash
# Vercel Functions内存限制
# Hobby: 1024MB
# Pro: 3008MB

# 检查内存使用
vercel logs | grep "Memory"

# 本地测试内存使用
node --max-old-space-size=1024 server.js
```

#### 内存优化
```typescript
// 1. 及时清理大对象
const largeData = await processLargeData()
// 使用完后立即清理
largeData = null

// 2. 避免内存泄露
// 正确清理事件监听器
useEffect(() => {
  const handler = () => {}
  window.addEventListener('resize', handler)
  return () => window.removeEventListener('resize', handler)
}, [])

// 3. 优化JSON处理
// 避免重复JSON.parse/stringify
const cachedData = useMemo(() => JSON.parse(data), [data])
```

---

## 🐛 开发环境问题

### 本地开发环境搭建

#### Node.js版本问题
```bash
# 检查Node版本
node --version

# 要求：Node.js 18+
# 使用nvm管理版本
nvm install 18
nvm use 18
```

#### 依赖安装问题
```bash
# 清理依赖
rm -rf node_modules package-lock.json
npm cache clean --force

# 重新安装
npm install

# 如果仍有问题，尝试yarn
yarn install
```

#### 数据库初始化
```bash
# 1. 创建数据库文件
npx prisma migrate dev --name init

# 2. 生成Prisma客户端
npx prisma generate

# 3. 查看数据库
npx prisma studio

# 4. 重置数据库（如果需要）
npx prisma migrate reset
```

### 开发服务器问题

#### 热重载不工作
```bash
# 检查文件监听
# 在package.json中确认dev脚本
"scripts": {
  "dev": "next dev"
}

# 重启开发服务器
npm run dev

# 如果仍有问题，检查文件权限
chmod -R 755 src/
```

#### TypeScript错误
```bash
# 类型检查
npx tsc --noEmit

# 常见错误解决：
# 1. 安装类型定义
npm install --save-dev @types/node @types/react

# 2. 更新tsconfig.json
{
  "compilerOptions": {
    "strict": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true
  }
}
```

---

## 📊 监控和日志

### 日志收集

#### Vercel日志查看
```bash
# 实时日志
vercel logs --follow

# 特定时间范围
vercel logs --since=1h

# 特定函数日志
vercel logs --scope=generate-menu

# 下载日志文件
vercel logs --output=logs.txt
```

#### 日志分析
```bash
# 统计错误类型
grep "Error" logs.txt | sort | uniq -c

# 分析响应时间
grep "Duration" logs.txt | awk '{print $NF}' | sort -n

# 查找异常模式
grep -E "(failed|error|timeout)" logs.txt
```

### 监控指标

#### 关键指标监控
```typescript
// 应用内监控代码
const metrics = {
  apiCalls: 0,
  errors: 0,
  avgResponseTime: 0,
  activeUsers: 0
}

// API调用计数
export async function POST(request: NextRequest) {
  const startTime = Date.now()
  metrics.apiCalls++
  
  try {
    // 业务逻辑
    const result = await processRequest(request)
    return result
  } catch (error) {
    metrics.errors++
    throw error
  } finally {
    const duration = Date.now() - startTime
    metrics.avgResponseTime = (metrics.avgResponseTime + duration) / 2
  }
}
```

#### 外部监控
```bash
# 使用curl监控可用性
#!/bin/bash
URL="https://ai-menu.tech"
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $URL)

if [ $RESPONSE -ne 200 ]; then
  echo "网站异常，状态码：$RESPONSE"
  # 发送告警
fi
```

---

## 🔄 故障恢复

### 数据恢复

#### 数据库恢复
```bash
# 1. 从备份恢复
psql $DATABASE_URL < backup.sql

# 2. Vercel Postgres自动备份恢复
# 通过Vercel控制台恢复到指定时间点

# 3. 手动数据修复
# 连接到数据库修复损坏数据
npx prisma studio
```

#### 应用状态恢复
```bash
# 1. 重新部署
vercel --prod

# 2. 清理缓存
# Vercel会自动处理CDN缓存

# 3. 验证功能
# 手动测试关键功能：
# - 用户登录
# - 菜单生成  
# - Excel导出
```

### 灾难恢复

#### 完全重建流程
```bash
# 1. 克隆代码仓库
git clone <repository-url>
cd ai-menu-040

# 2. 安装依赖
npm install

# 3. 配置环境变量
cp env.example .env
# 编辑.env文件

# 4. 初始化数据库
npx prisma migrate deploy
npx prisma generate

# 5. 部署到Vercel
vercel --prod

# 6. 恢复数据
psql $DATABASE_URL < backup.sql

# 7. 验证系统功能
```

---

## 📚 故障预防

### 预防措施

#### 代码质量
```bash
# 代码检查
npm run lint
npm run type-check

# 自动化测试
npm test

# 安全扫描
npm audit
```

#### 监控告警
```typescript
// 关键路径监控
const monitor = {
  // API响应时间监控
  checkResponseTime: (duration: number) => {
    if (duration > 5000) {
      console.warn(`API响应时间过长: ${duration}ms`)
      // 发送告警
    }
  },
  
  // 错误率监控
  checkErrorRate: (errors: number, total: number) => {
    const errorRate = errors / total
    if (errorRate > 0.05) {
      console.error(`错误率过高: ${errorRate * 100}%`)
      // 发送告警
    }
  }
}
```

#### 定期维护
```bash
#!/bin/bash
# 定期维护脚本

# 1. 更新依赖
npm update

# 2. 清理日志
find logs/ -name "*.log" -mtime +30 -delete

# 3. 数据库维护
npx prisma db push

# 4. 安全扫描
npm audit --audit-level high

# 5. 性能测试
npm run perf-test
```

---

## 📞 支持联系

### 技术支持分级

#### L1支持（用户问题）
- **响应时间**：1-4小时
- **处理范围**：登录问题、使用指导
- **联系方式**：微信 lyratng

#### L2支持（系统问题）  
- **响应时间**：2-8小时
- **处理范围**：功能异常、性能问题
- **联系方式**：技术团队群

#### L3支持（紧急故障）
- **响应时间**：30分钟内
- **处理范围**：系统中断、数据丢失
- **联系方式**：紧急联系人电话

### 故障报告模板

```
故障类型：[系统中断/功能异常/性能问题]
发生时间：YYYY-MM-DD HH:MM:SS
影响范围：[全系统/部分用户/单个功能]
症状描述：具体的错误现象
重现步骤：
1. 
2. 
3. 

错误信息：[贴出具体错误日志]
环境信息：[浏览器/设备/网络]
紧急程度：[低/中/高/紧急]
```

---

## 📋 故障处理检查清单

### 问题排查清单

- [ ] 确认问题具体症状和影响范围
- [ ] 检查系统基础设施状态
- [ ] 查看相关错误日志
- [ ] 验证配置和环境变量
- [ ] 测试数据库连接
- [ ] 检查第三方服务状态
- [ ] 确认最近的代码变更
- [ ] 尝试重现问题

### 解决后验证清单

- [ ] 问题已完全解决
- [ ] 核心功能正常工作
- [ ] 性能指标正常
- [ ] 用户可正常访问
- [ ] 相关监控正常
- [ ] 文档已更新
- [ ] 团队已通知
- [ ] 预防措施已实施

---

