# å›¢é¤èœå•ç”Ÿæˆå·¥å…· - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## ğŸ“– æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†å›¢é¤èœå•ç”Ÿæˆå·¥å…·çš„æ•°æ®åº“è®¾è®¡ï¼ŒåŒ…æ‹¬è¡¨ç»“æ„ã€å­—æ®µå®šä¹‰ã€å…³ç³»æ˜ å°„ã€ç´¢å¼•è®¾è®¡ç­‰ã€‚æ•°æ®åº“è®¾è®¡éµå¾ªç¬¬ä¸‰èŒƒå¼ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’ŒæŸ¥è¯¢æ•ˆç‡ã€‚

### æŠ€æœ¯é€‰å‹

- **ORMæ¡†æ¶**ï¼šPrisma
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šPostgreSQL 13+
- **å¼€å‘ç¯å¢ƒ**ï¼šSQLite
- **å­—ç¬¦ç¼–ç **ï¼šUTF-8
- **æ—¶åŒºè®¾ç½®**ï¼šUTC

---

## ğŸ— æ•°æ®åº“æ¶æ„

### æ•´ä½“è®¾è®¡åŸåˆ™

1. **æ•°æ®éš”ç¦»**ï¼šæ¯ä¸ªé£Ÿå ‚çš„æ•°æ®å®Œå…¨éš”ç¦»ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²
2. **å†å²è¿½è¸ª**ï¼šä¿ç•™èœå•ç”Ÿæˆå†å²ï¼Œæ”¯æŒæ•°æ®åˆ†æ
3. **æ‰©å±•æ€§**ï¼šé¢„ç•™æ‰©å±•å­—æ®µï¼Œæ”¯æŒåŠŸèƒ½è¿­ä»£
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†è®¾ç½®ç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### æ•°æ®åº“å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Canteen     â”‚ 1   n â”‚      Menu       â”‚
â”‚  (é£Ÿå ‚ä¿¡æ¯è¡¨)    â”‚ â”€â”€â”€â”€â†’ â”‚   (èœå•è®°å½•è¡¨)   â”‚
â”‚                 â”‚       â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š è¡¨ç»“æ„è®¾è®¡

### 1. Canteen è¡¨ï¼ˆé£Ÿå ‚ä¿¡æ¯è¡¨ï¼‰

**è¡¨å**ï¼š`canteens`

**åŠŸèƒ½**ï¼šå­˜å‚¨é£Ÿå ‚çš„åŸºæœ¬ä¿¡æ¯å’Œé…ç½®

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|----------|------|--------|------|
| `id` | String | PRIMARY KEY | cuid() | é£Ÿå ‚å”¯ä¸€æ ‡è¯†ç¬¦ |
| `canteenName` | String | UNIQUE, NOT NULL | - | é£Ÿå ‚åç§°ï¼Œç”¨äºç™»å½• |
| `password` | String | NOT NULL | - | åŠ å¯†åçš„ç™»å½•å¯†ç  |
| `hotDishCount` | Int | NOT NULL | 8 | æ¯æ—¥çƒ­èœæ•°é‡é…ç½® |
| `coldDishCount` | Int | NOT NULL | 3 | æ¯æ—¥å‡‰èœæ•°é‡é…ç½® |
| `mealType` | String | NOT NULL | - | é¤åˆ¶ç±»å‹ï¼ˆå®šä»·é¤/è‡ªåŠ©é¤ï¼‰ |
| `historicalMenus` | Json | NOT NULL | - | å†å²èœå•æ•°æ®ï¼ˆ4ä¸ªExcelè§£æç»“æœï¼‰ |
| `createdAt` | DateTime | NOT NULL | now() | åˆ›å»ºæ—¶é—´ |
| `updatedAt` | DateTime | NOT NULL | now() | æœ€åæ›´æ–°æ—¶é—´ |

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- ä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
PRIMARY KEY (id)

-- å”¯ä¸€ç´¢å¼•ï¼šç¡®ä¿é£Ÿå ‚åç§°å”¯ä¸€
UNIQUE INDEX canteens_canteenName_key ON canteens(canteenName)

-- å¤åˆç´¢å¼•ï¼šä¼˜åŒ–æŒ‰åˆ›å»ºæ—¶é—´æŸ¥è¯¢
INDEX canteens_createdAt_idx ON canteens(createdAt DESC)
```

**å­—æ®µè¯¦ç»†è¯´æ˜**ï¼š

#### `id`
- **ç±»å‹**ï¼šString (CUID)
- **è¯´æ˜**ï¼šä½¿ç”¨CUIDç”Ÿæˆç®—æ³•ï¼Œç¡®ä¿å…¨å±€å”¯ä¸€ä¸”ä¸å¯é¢„æµ‹
- **ç¤ºä¾‹**ï¼š`clh7x3k4y0000abcdefghijkl`

#### `canteenName`
- **ç±»å‹**ï¼šString
- **çº¦æŸ**ï¼š2-50å­—ç¬¦ï¼Œä¸­è‹±æ–‡æ•°å­—å‡å¯
- **ç”¨é€”**ï¼šç”¨æˆ·ç™»å½•çš„ç”¨æˆ·åï¼Œç³»ç»Ÿå†…å”¯ä¸€æ ‡è¯†
- **ç¤ºä¾‹**ï¼š`"XXå…¬å¸å‘˜å·¥é¤å…"`

#### `password`
- **ç±»å‹**ï¼šString
- **å®‰å…¨æ€§**ï¼šä½¿ç”¨bcryptåŠ å¯†ï¼Œæˆæœ¬å› å­12
- **å­˜å‚¨æ ¼å¼**ï¼š`$2b$12$...` (bcrypt hash)
- **è¯´æ˜**ï¼šæ°¸è¿œä¸ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨æˆ–ä¼ è¾“

#### `historicalMenus`
- **ç±»å‹**ï¼šJSON Array
- **ç»“æ„**ï¼š`string[][]` - äºŒç»´æ•°ç»„
- **è¯´æ˜**ï¼šå­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„4ä¸ªExcelæ–‡ä»¶è§£æç»“æœ
- **ç¤ºä¾‹**ï¼š
```json
[
  ["çº¢çƒ§è‚‰", "æ¸…ç‚’ç™½èœ", "é…¸è¾£åœŸè±†ä¸", "è’¸è›‹ç¾¹"],
  ["ç³–é†‹é‡Œè„Š", "å®«ä¿é¸¡ä¸", "éº»å©†è±†è…", "å‡‰æ‹Œé»„ç“œ"],
  ["..."],
  ["..."]
]
```

### 2. Menu è¡¨ï¼ˆèœå•è®°å½•è¡¨ï¼‰

**è¡¨å**ï¼š`menus`

**åŠŸèƒ½**ï¼šå­˜å‚¨AIç”Ÿæˆçš„èœå•è®°å½•å’Œç”Ÿæˆå‚æ•°

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|----------|------|--------|------|
| `id` | String | PRIMARY KEY | cuid() | èœå•è®°å½•å”¯ä¸€æ ‡è¯†ç¬¦ |
| `canteenId` | String | FOREIGN KEY, NOT NULL | - | å…³è”çš„é£Ÿå ‚ID |
| `weekMenu` | Json | NOT NULL | - | ä¸€å‘¨èœå•æ•°æ® |
| `generationParams` | Json | NOT NULL | - | ç”Ÿæˆæ—¶ä½¿ç”¨çš„å‚æ•° |
| `createdAt` | DateTime | NOT NULL | now() | ç”Ÿæˆæ—¶é—´ |

**å¤–é”®çº¦æŸ**ï¼š
```sql
FOREIGN KEY (canteenId) REFERENCES canteens(id) ON DELETE CASCADE
```

**ç´¢å¼•è®¾è®¡**ï¼š
```sql
-- ä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
PRIMARY KEY (id)

-- å¤–é”®ç´¢å¼•ï¼šä¼˜åŒ–æŒ‰é£Ÿå ‚æŸ¥è¯¢èœå•
INDEX menus_canteenId_idx ON menus(canteenId)

-- å¤åˆç´¢å¼•ï¼šæŒ‰é£Ÿå ‚å’Œæ—¶é—´æ’åºæŸ¥è¯¢
INDEX menus_canteenId_createdAt_idx ON menus(canteenId, createdAt DESC)

-- æ—¶é—´ç´¢å¼•ï¼šæ”¯æŒå…¨å±€æ—¶é—´èŒƒå›´æŸ¥è¯¢
INDEX menus_createdAt_idx ON menus(createdAt DESC)
```

**å­—æ®µè¯¦ç»†è¯´æ˜**ï¼š

#### `weekMenu`
- **ç±»å‹**ï¼šJSON Object
- **ç»“æ„**ï¼šç¬¦åˆ`WeekMenu`æ¥å£å®šä¹‰
- **ç¤ºä¾‹**ï¼š
```json
{
  "monday": [
    "çº¢çƒ§è‚‰(ä¸»è¤)",
    "é’æ¤’è‚‰ä¸(åŠè¤)",
    "æ¸…ç‚’å°ç™½èœ(ç´ èœ)",
    "å‡‰æ‹Œé»„ç“œ(å‡‰èœ)"
  ],
  "tuesday": ["..."],
  "wednesday": ["..."],
  "thursday": ["..."],
  "friday": ["..."]
}
```

#### `generationParams`
- **ç±»å‹**ï¼šJSON Object
- **ç»“æ„**ï¼šç¬¦åˆ`GenerationParams`æ¥å£å®šä¹‰
- **ç”¨é€”**ï¼šè®°å½•ç”Ÿæˆèœå•æ—¶çš„æ‰€æœ‰å‚æ•°ï¼Œæ”¯æŒå¤ç°å’Œåˆ†æ
- **ç¤ºä¾‹**ï¼š
```json
{
  "mainMeatCount": 3,
  "halfMeatCount": 3,
  "vegetarianCount": 2,
  "staffSituation": "scarce",
  "historicalRatio": 30,
  "equipmentShortage": ["è’¸å±‰"],
  "spicyLevel": "mild",
  "flavorDiversity": false,
  "workRatio": "æ— è¦æ±‚",
  "ingredientDiversity": "æ— è¦æ±‚"
}
```

---

## ğŸ”— æ•°æ®å…³ç³»

### ä¸€å¯¹å¤šå…³ç³»

**Canteen â†” Menu**
- **å…³ç³»ç±»å‹**ï¼šä¸€å¯¹å¤šï¼ˆ1:Nï¼‰
- **ä¸šåŠ¡å«ä¹‰**ï¼šä¸€ä¸ªé£Ÿå ‚å¯ä»¥æœ‰å¤šä¸ªèœå•è®°å½•
- **å®ç°æ–¹å¼**ï¼š`Menu.canteenId` å¤–é”®å¼•ç”¨ `Canteen.id`
- **çº§è”åˆ é™¤**ï¼šåˆ é™¤é£Ÿå ‚æ—¶è‡ªåŠ¨åˆ é™¤æ‰€æœ‰ç›¸å…³èœå•

### æ•°æ®éš”ç¦»ç­–ç•¥

```sql
-- æŸ¥è¯¢æŸé£Ÿå ‚çš„èœå•æ—¶ï¼Œå¿…é¡»å¸¦ä¸ŠcanteenIdæ¡ä»¶
SELECT * FROM menus WHERE canteenId = ? ORDER BY createdAt DESC;

-- ç¡®ä¿ä¸åŒé£Ÿå ‚é—´æ•°æ®å®Œå…¨éš”ç¦»
-- æ‰€æœ‰ä¸šåŠ¡æŸ¥è¯¢éƒ½é€šè¿‡canteenIdè¿›è¡Œè¿‡æ»¤
```

---

## ğŸ“ˆ æŸ¥è¯¢ä¼˜åŒ–

### å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼

#### 1. ç”¨æˆ·ç™»å½•éªŒè¯
```sql
SELECT id, canteenName, password, hotDishCount, coldDishCount, mealType, createdAt 
FROM canteens 
WHERE canteenName = ?;
```
**ä¼˜åŒ–**ï¼š`canteenName`ä¸Šçš„å”¯ä¸€ç´¢å¼•ç¡®ä¿O(log n)æŸ¥è¯¢æ—¶é—´

#### 2. è·å–é£Ÿå ‚å†å²èœå•
```sql
SELECT id, weekMenu, generationParams, createdAt 
FROM menus 
WHERE canteenId = ? 
ORDER BY createdAt DESC 
LIMIT 4;
```
**ä¼˜åŒ–**ï¼š`(canteenId, createdAt DESC)`å¤åˆç´¢å¼•æ”¯æŒé«˜æ•ˆæ’åºæŸ¥è¯¢

#### 3. æ¸…ç†è¶…é‡å†å²è®°å½•
```sql
DELETE FROM menus 
WHERE canteenId = ? 
  AND id NOT IN (
    SELECT id FROM menus 
    WHERE canteenId = ? 
    ORDER BY createdAt DESC 
    LIMIT 4
  );
```
**ä¼˜åŒ–**ï¼šé€šè¿‡ç´¢å¼•å¿«é€Ÿå®šä½éœ€è¦åˆ é™¤çš„è®°å½•

### æ€§èƒ½è°ƒä¼˜å»ºè®®

1. **è¿æ¥æ± é…ç½®**
```javascript
// Prismaè¿æ¥æ± é…ç½®
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // è¿æ¥æ± å¤§å°
  connection_limit = 10
}
```

2. **æŸ¥è¯¢ç¼“å­˜**
```typescript
// å¯¹äºä¸é¢‘ç¹å˜åŒ–çš„é£Ÿå ‚ä¿¡æ¯ï¼Œå¯æ·»åŠ åº”ç”¨å±‚ç¼“å­˜
const canteenCache = new Map<string, Canteen>()
```

3. **æ‰¹é‡æ“ä½œ**
```typescript
// æ¸…ç†å†å²è®°å½•æ—¶ä½¿ç”¨äº‹åŠ¡
await prisma.$transaction([
  // åˆ é™¤å¤šä½™è®°å½•
  prisma.menu.deleteMany({...}),
  // æ’å…¥æ–°è®°å½•
  prisma.menu.create({...})
])
```

---

## ğŸ” æ•°æ®å®‰å…¨

### æ•æ„Ÿæ•°æ®å¤„ç†

#### å¯†ç å®‰å…¨
- **åŠ å¯†ç®—æ³•**ï¼šbcrypt (cost factor: 12)
- **å­˜å‚¨æ ¼å¼**ï¼šå“ˆå¸Œå€¼ + ç›å€¼
- **ä¼ è¾“å®‰å…¨**ï¼šHTTPSåŠ å¯†ä¼ è¾“
- **è®¿é—®æ§åˆ¶**ï¼šæŸ¥è¯¢æ—¶è‡ªåŠ¨æ’é™¤passwordå­—æ®µ

#### æ•°æ®éš”ç¦»
- **è¡Œçº§å®‰å…¨**ï¼šé€šè¿‡canteenIdä¸¥æ ¼éš”ç¦»
- **åº”ç”¨å±‚æ£€æŸ¥**ï¼šæ‰€æœ‰æŸ¥è¯¢éƒ½å¿…é¡»åŒ…å«é£Ÿå ‚æƒé™éªŒè¯
- **JWTè®¤è¯**ï¼šTokenä¸­åŒ…å«canteenIdï¼Œç¡®ä¿è®¿é—®æƒé™

### æ•°æ®å¤‡ä»½ç­–ç•¥

#### è‡ªåŠ¨å¤‡ä»½
```sql
-- PostgreSQLè‡ªåŠ¨å¤‡ä»½é…ç½®
-- 1. æ—¥å¤‡ä»½ï¼šä¿ç•™7å¤©
-- 2. å‘¨å¤‡ä»½ï¼šä¿ç•™4å‘¨  
-- 3. æœˆå¤‡ä»½ï¼šä¿ç•™12ä¸ªæœˆ
```

#### æ‰‹åŠ¨å¤‡ä»½
```bash
# å¯¼å‡ºç‰¹å®šé£Ÿå ‚æ•°æ®
pg_dump --table=canteens --table=menus \
        --where="canteenId='specific_id'" \
        $DATABASE_URL > canteen_backup.sql
```

---

## ğŸ“Š æ•°æ®ç»Ÿè®¡

### å­˜å‚¨ç©ºé—´ä¼°ç®—

#### å•ä¸ªé£Ÿå ‚æ•°æ®é‡
- **Canteenè®°å½•**ï¼š~2KBï¼ˆåŒ…å«å†å²èœå•JSONï¼‰
- **å•ä¸ªMenuè®°å½•**ï¼š~1KBï¼ˆä¸€å‘¨èœå• + å‚æ•°ï¼‰
- **æœˆæ´»è·ƒåº¦å‡è®¾**ï¼šå¹³å‡æ¯å‘¨ç”Ÿæˆ1æ¬¡èœå•

#### å®¹é‡è§„åˆ’
```
100ä¸ªé£Ÿå ‚ Ã— 52å‘¨/å¹´ Ã— 1KB/èœå• = ~5.2MB/å¹´/100é£Ÿå ‚
1000ä¸ªé£Ÿå ‚ = ~52MB/å¹´

å†å²èœå•æ•°æ®ï¼š1000é£Ÿå ‚ Ã— 2KB = ~2MB

æ€»è®¡ï¼šçº¦54MB/å¹´/1000é£Ÿå ‚ï¼ˆéå¸¸ç»æµï¼‰
```

### æ€§èƒ½åŸºå‡†

| æ“ä½œç±»å‹ | ç›®æ ‡å“åº”æ—¶é—´ | å¹¶å‘æ”¯æŒ |
|---------|--------------|----------|
| ç”¨æˆ·ç™»å½• | < 200ms | 100+ |
| èœå•ç”Ÿæˆ | < 3s | 10+ |
| å†å²æŸ¥è¯¢ | < 100ms | 200+ |
| Excelå¯¼å‡º | < 500ms | 50+ |

---

## ğŸ›  æ•°æ®åº“ç»´æŠ¤

### å®šæœŸç»´æŠ¤ä»»åŠ¡

#### 1. æ¸…ç†è¿‡æœŸæ•°æ®
```sql
-- æ¸…ç†è¶…è¿‡1å¹´çš„èœå•è®°å½•ï¼ˆå¯é€‰ï¼‰
DELETE FROM menus 
WHERE createdAt < NOW() - INTERVAL '1 year';
```

#### 2. é‡å»ºç´¢å¼•
```sql
-- PostgreSQLè‡ªåŠ¨ç»´æŠ¤ç´¢å¼•ï¼Œä¸€èˆ¬æ— éœ€æ‰‹åŠ¨é‡å»º
REINDEX DATABASE menu_generator;
```

#### 3. åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
```sql
-- æ›´æ–°æŸ¥è¯¢ä¼˜åŒ–å™¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE canteens;
ANALYZE menus;
```

### ç›‘æ§æŒ‡æ ‡

#### å…³é”®ç›‘æ§ç‚¹
- **è¿æ¥æ•°**ï¼šç›‘æ§æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨æƒ…å†µ
- **æŸ¥è¯¢æ—¶é—´**ï¼šç›‘æ§æ…¢æŸ¥è¯¢ï¼ˆ>1sï¼‰
- **å­˜å‚¨ç©ºé—´**ï¼šç›‘æ§æ•°æ®åº“å¤§å°å¢é•¿
- **é”ç­‰å¾…**ï¼šç›‘æ§äº‹åŠ¡å†²çªæƒ…å†µ

#### å‘Šè­¦è®¾ç½®
```sql
-- æ…¢æŸ¥è¯¢ç›‘æ§
SELECT query, mean_time, calls 
FROM pg_stat_statements 
WHERE mean_time > 1000  -- è¶…è¿‡1ç§’çš„æŸ¥è¯¢
ORDER BY mean_time DESC;
```

---

## ğŸ”„ è¿ç§»å’Œå‡çº§

### æ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶

Prisma Migrateç®¡ç†æ•°æ®åº“ç»“æ„å˜æ›´ï¼š

```bash
# åˆ›å»ºæ–°è¿ç§»
npx prisma migrate dev --name add_new_feature

# ç”Ÿäº§ç¯å¢ƒåº”ç”¨è¿ç§»
npx prisma migrate deploy

# æŸ¥çœ‹è¿ç§»çŠ¶æ€
npx prisma migrate status
```

### æ•°æ®è¿ç§»ç¤ºä¾‹

#### æ·»åŠ æ–°å­—æ®µ
```sql
-- migration: 20250915_add_nutrition_info.sql
ALTER TABLE menus ADD COLUMN nutrition_info JSON;
```

#### æ•°æ®ç»“æ„è°ƒæ•´
```typescript
// å¦‚æœéœ€è¦è°ƒæ•´historicalMenusç»“æ„
await prisma.$executeRaw`
  UPDATE canteens 
  SET historicalMenus = CAST(
    ARRAY_TO_JSON(
      ARRAY(SELECT UNNEST(CAST(historicalMenus AS TEXT[])))
    ) AS JSON
  )
  WHERE historicalMenus IS NOT NULL;
`
```

---

## ğŸ“š å¼€å‘è€…æŒ‡å—

### Prismaå®¢æˆ·ç«¯ä½¿ç”¨

#### åŸºç¡€æŸ¥è¯¢
```typescript
// æŸ¥æ‰¾é£Ÿå ‚ï¼ˆæ’é™¤å¯†ç ï¼‰
const canteen = await prisma.canteen.findUnique({
  where: { canteenName },
  select: {
    id: true,
    canteenName: true,
    hotDishCount: true,
    coldDishCount: true,
    mealType: true,
    historicalMenus: true,
    createdAt: true
  }
})

// æŸ¥è¯¢é£Ÿå ‚çš„èœå•å†å²
const menus = await prisma.menu.findMany({
  where: { canteenId },
  orderBy: { createdAt: 'desc' },
  take: 4
})
```

#### äº‹åŠ¡æ“ä½œ
```typescript
// åˆ›å»ºèœå•å¹¶æ¸…ç†å†å²è®°å½•
const result = await prisma.$transaction(async (tx) => {
  // åˆ›å»ºæ–°èœå•
  const newMenu = await tx.menu.create({
    data: { canteenId, weekMenu, generationParams }
  })
  
  // ä¿ç•™æœ€æ–°4æ¡è®°å½•
  const allMenus = await tx.menu.findMany({
    where: { canteenId },
    orderBy: { createdAt: 'desc' }
  })
  
  if (allMenus.length > 4) {
    await tx.menu.deleteMany({
      where: {
        id: { in: allMenus.slice(4).map(m => m.id) }
      }
    })
  }
  
  return newMenu
})
```

### ç±»å‹å®‰å…¨

```typescript
// ä½¿ç”¨Prismaç”Ÿæˆçš„ç±»å‹
import type { Canteen, Menu } from '@prisma/client'

// æ’é™¤æ•æ„Ÿå­—æ®µçš„ç±»å‹
type SafeCanteen = Omit<Canteen, 'password'>

// èœå•å…³è”æŸ¥è¯¢ç±»å‹
type CanteenWithMenus = Canteen & {
  menus: Menu[]
}
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¸¸è§é—®é¢˜

#### Q: å¦‚ä½•é‡ç½®é£Ÿå ‚å¯†ç ï¼Ÿ
A: 
```typescript
const hashedPassword = await bcrypt.hash(newPassword, 12)
await prisma.canteen.update({
  where: { id: canteenId },
  data: { password: hashedPassword }
})
```

#### Q: å¦‚ä½•å¤‡ä»½ç‰¹å®šé£Ÿå ‚æ•°æ®ï¼Ÿ
A:
```typescript
const backup = await prisma.canteen.findUnique({
  where: { id: canteenId },
  include: { menus: true }
})
```

#### Q: å¦‚ä½•æ¸…ç†æµ‹è¯•æ•°æ®ï¼Ÿ
A:
```typescript
// åˆ é™¤æµ‹è¯•é£Ÿå ‚ï¼ˆä¼šçº§è”åˆ é™¤ç›¸å…³èœå•ï¼‰
await prisma.canteen.deleteMany({
  where: { canteenName: { startsWith: 'test_' } }
})
```

### æ•°æ®åº“å·¥å…·

- **å¯è§†åŒ–ç®¡ç†**ï¼š`npx prisma studio`
- **SchemaæŸ¥çœ‹**ï¼š`npx prisma db pull`
- **æ•°æ®é‡ç½®**ï¼š`npx prisma migrate reset`

---

\
