# 团餐菜单生成工具 - 数据库设计文档

## 📖 概述

本文档详细描述了团餐菜单生成工具的数据库设计，包括表结构、字段定义、关系映射、索引设计等。数据库设计遵循第三范式，确保数据一致性和查询效率。

### 技术选型

- **ORM框架**：Prisma
- **生产环境**：PostgreSQL 13+
- **开发环境**：SQLite
- **字符编码**：UTF-8
- **时区设置**：UTC

---

## 🏗 数据库架构

### 整体设计原则

1. **数据隔离**：每个食堂的数据完全隔离，防止数据泄露
2. **历史追踪**：保留菜单生成历史，支持数据分析
3. **扩展性**：预留扩展字段，支持功能迭代
4. **性能优化**：合理设置索引，优化查询性能

### 数据库关系图

```
┌─────────────────┐       ┌─────────────────┐
│     Canteen     │ 1   n │      Menu       │
│  (食堂信息表)    │ ────→ │   (菜单记录表)   │
│                 │       │                 │
└─────────────────┘       └─────────────────┘
```

---

## 📊 表结构设计

### 1. Canteen 表（食堂信息表）

**表名**：`canteens`

**功能**：存储食堂的基本信息和配置

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| `id` | String | PRIMARY KEY | cuid() | 食堂唯一标识符 |
| `canteenName` | String | UNIQUE, NOT NULL | - | 食堂名称，用于登录 |
| `password` | String | NOT NULL | - | 加密后的登录密码 |
| `hotDishCount` | Int | NOT NULL | 8 | 每日热菜数量配置 |
| `coldDishCount` | Int | NOT NULL | 3 | 每日凉菜数量配置 |
| `mealType` | String | NOT NULL | - | 餐制类型（定价餐/自助餐） |
| `historicalMenus` | Json | NOT NULL | - | 历史菜单数据（4个Excel解析结果） |
| `createdAt` | DateTime | NOT NULL | now() | 创建时间 |
| `updatedAt` | DateTime | NOT NULL | now() | 最后更新时间 |

**索引设计**：
```sql
-- 主键索引（自动创建）
PRIMARY KEY (id)

-- 唯一索引：确保食堂名称唯一
UNIQUE INDEX canteens_canteenName_key ON canteens(canteenName)

-- 复合索引：优化按创建时间查询
INDEX canteens_createdAt_idx ON canteens(createdAt DESC)
```

**字段详细说明**：

#### `id`
- **类型**：String (CUID)
- **说明**：使用CUID生成算法，确保全局唯一且不可预测
- **示例**：`clh7x3k4y0000abcdefghijkl`

#### `canteenName`
- **类型**：String
- **约束**：2-50字符，中英文数字均可
- **用途**：用户登录的用户名，系统内唯一标识
- **示例**：`"XX公司员工餐厅"`

#### `password`
- **类型**：String
- **安全性**：使用bcrypt加密，成本因子12
- **存储格式**：`$2b$12$...` (bcrypt hash)
- **说明**：永远不以明文形式存储或传输

#### `historicalMenus`
- **类型**：JSON Array
- **结构**：`string[][]` - 二维数组
- **说明**：存储用户上传的4个Excel文件解析结果
- **示例**：
```json
[
  ["红烧肉", "清炒白菜", "酸辣土豆丝", "蒸蛋羹"],
  ["糖醋里脊", "宫保鸡丁", "麻婆豆腐", "凉拌黄瓜"],
  ["..."],
  ["..."]
]
```

### 2. Menu 表（菜单记录表）

**表名**：`menus`

**功能**：存储AI生成的菜单记录和生成参数

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| `id` | String | PRIMARY KEY | cuid() | 菜单记录唯一标识符 |
| `canteenId` | String | FOREIGN KEY, NOT NULL | - | 关联的食堂ID |
| `weekMenu` | Json | NOT NULL | - | 一周菜单数据 |
| `generationParams` | Json | NOT NULL | - | 生成时使用的参数 |
| `createdAt` | DateTime | NOT NULL | now() | 生成时间 |

**外键约束**：
```sql
FOREIGN KEY (canteenId) REFERENCES canteens(id) ON DELETE CASCADE
```

**索引设计**：
```sql
-- 主键索引（自动创建）
PRIMARY KEY (id)

-- 外键索引：优化按食堂查询菜单
INDEX menus_canteenId_idx ON menus(canteenId)

-- 复合索引：按食堂和时间排序查询
INDEX menus_canteenId_createdAt_idx ON menus(canteenId, createdAt DESC)

-- 时间索引：支持全局时间范围查询
INDEX menus_createdAt_idx ON menus(createdAt DESC)
```

**字段详细说明**：

#### `weekMenu`
- **类型**：JSON Object
- **结构**：符合`WeekMenu`接口定义
- **示例**：
```json
{
  "monday": [
    "红烧肉(主荤)",
    "青椒肉丝(半荤)",
    "清炒小白菜(素菜)",
    "凉拌黄瓜(凉菜)"
  ],
  "tuesday": ["..."],
  "wednesday": ["..."],
  "thursday": ["..."],
  "friday": ["..."]
}
```

#### `generationParams`
- **类型**：JSON Object
- **结构**：符合`GenerationParams`接口定义
- **用途**：记录生成菜单时的所有参数，支持复现和分析
- **示例**：
```json
{
  "mainMeatCount": 3,
  "halfMeatCount": 3,
  "vegetarianCount": 2,
  "staffSituation": "scarce",
  "historicalRatio": 30,
  "equipmentShortage": ["蒸屉"],
  "spicyLevel": "mild",
  "flavorDiversity": false,
  "workRatio": "无要求",
  "ingredientDiversity": "无要求"
}
```

---

## 🔗 数据关系

### 一对多关系

**Canteen ↔ Menu**
- **关系类型**：一对多（1:N）
- **业务含义**：一个食堂可以有多个菜单记录
- **实现方式**：`Menu.canteenId` 外键引用 `Canteen.id`
- **级联删除**：删除食堂时自动删除所有相关菜单

### 数据隔离策略

```sql
-- 查询某食堂的菜单时，必须带上canteenId条件
SELECT * FROM menus WHERE canteenId = ? ORDER BY createdAt DESC;

-- 确保不同食堂间数据完全隔离
-- 所有业务查询都通过canteenId进行过滤
```

---

## 📈 查询优化

### 常用查询模式

#### 1. 用户登录验证
```sql
SELECT id, canteenName, password, hotDishCount, coldDishCount, mealType, createdAt 
FROM canteens 
WHERE canteenName = ?;
```
**优化**：`canteenName`上的唯一索引确保O(log n)查询时间

#### 2. 获取食堂历史菜单
```sql
SELECT id, weekMenu, generationParams, createdAt 
FROM menus 
WHERE canteenId = ? 
ORDER BY createdAt DESC 
LIMIT 4;
```
**优化**：`(canteenId, createdAt DESC)`复合索引支持高效排序查询

#### 3. 清理超量历史记录
```sql
DELETE FROM menus 
WHERE canteenId = ? 
  AND id NOT IN (
    SELECT id FROM menus 
    WHERE canteenId = ? 
    ORDER BY createdAt DESC 
    LIMIT 4
  );
```
**优化**：通过索引快速定位需要删除的记录

### 性能调优建议

1. **连接池配置**
```javascript
// Prisma连接池配置
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // 连接池大小
  connection_limit = 10
}
```

2. **查询缓存**
```typescript
// 对于不频繁变化的食堂信息，可添加应用层缓存
const canteenCache = new Map<string, Canteen>()
```

3. **批量操作**
```typescript
// 清理历史记录时使用事务
await prisma.$transaction([
  // 删除多余记录
  prisma.menu.deleteMany({...}),
  // 插入新记录
  prisma.menu.create({...})
])
```

---

## 🔐 数据安全

### 敏感数据处理

#### 密码安全
- **加密算法**：bcrypt (cost factor: 12)
- **存储格式**：哈希值 + 盐值
- **传输安全**：HTTPS加密传输
- **访问控制**：查询时自动排除password字段

#### 数据隔离
- **行级安全**：通过canteenId严格隔离
- **应用层检查**：所有查询都必须包含食堂权限验证
- **JWT认证**：Token中包含canteenId，确保访问权限

### 数据备份策略

#### 自动备份
```sql
-- PostgreSQL自动备份配置
-- 1. 日备份：保留7天
-- 2. 周备份：保留4周  
-- 3. 月备份：保留12个月
```

#### 手动备份
```bash
# 导出特定食堂数据
pg_dump --table=canteens --table=menus \
        --where="canteenId='specific_id'" \
        $DATABASE_URL > canteen_backup.sql
```

---

## 📊 数据统计

### 存储空间估算

#### 单个食堂数据量
- **Canteen记录**：~2KB（包含历史菜单JSON）
- **单个Menu记录**：~1KB（一周菜单 + 参数）
- **月活跃度假设**：平均每周生成1次菜单

#### 容量规划
```
100个食堂 × 52周/年 × 1KB/菜单 = ~5.2MB/年/100食堂
1000个食堂 = ~52MB/年

历史菜单数据：1000食堂 × 2KB = ~2MB

总计：约54MB/年/1000食堂（非常经济）
```

### 性能基准

| 操作类型 | 目标响应时间 | 并发支持 |
|---------|--------------|----------|
| 用户登录 | < 200ms | 100+ |
| 菜单生成 | < 3s | 10+ |
| 历史查询 | < 100ms | 200+ |
| Excel导出 | < 500ms | 50+ |

---

## 🛠 数据库维护

### 定期维护任务

#### 1. 清理过期数据
```sql
-- 清理超过1年的菜单记录（可选）
DELETE FROM menus 
WHERE createdAt < NOW() - INTERVAL '1 year';
```

#### 2. 重建索引
```sql
-- PostgreSQL自动维护索引，一般无需手动重建
REINDEX DATABASE menu_generator;
```

#### 3. 分析表统计信息
```sql
-- 更新查询优化器统计信息
ANALYZE canteens;
ANALYZE menus;
```

### 监控指标

#### 关键监控点
- **连接数**：监控数据库连接池使用情况
- **查询时间**：监控慢查询（>1s）
- **存储空间**：监控数据库大小增长
- **锁等待**：监控事务冲突情况

#### 告警设置
```sql
-- 慢查询监控
SELECT query, mean_time, calls 
FROM pg_stat_statements 
WHERE mean_time > 1000  -- 超过1秒的查询
ORDER BY mean_time DESC;
```

---

## 🔄 迁移和升级

### 数据库版本控制

Prisma Migrate管理数据库结构变更：

```bash
# 创建新迁移
npx prisma migrate dev --name add_new_feature

# 生产环境应用迁移
npx prisma migrate deploy

# 查看迁移状态
npx prisma migrate status
```

### 数据迁移示例

#### 添加新字段
```sql
-- migration: 20250915_add_nutrition_info.sql
ALTER TABLE menus ADD COLUMN nutrition_info JSON;
```

#### 数据结构调整
```typescript
// 如果需要调整historicalMenus结构
await prisma.$executeRaw`
  UPDATE canteens 
  SET historicalMenus = CAST(
    ARRAY_TO_JSON(
      ARRAY(SELECT UNNEST(CAST(historicalMenus AS TEXT[])))
    ) AS JSON
  )
  WHERE historicalMenus IS NOT NULL;
`
```

---

## 📚 开发者指南

### Prisma客户端使用

#### 基础查询
```typescript
// 查找食堂（排除密码）
const canteen = await prisma.canteen.findUnique({
  where: { canteenName },
  select: {
    id: true,
    canteenName: true,
    hotDishCount: true,
    coldDishCount: true,
    mealType: true,
    historicalMenus: true,
    createdAt: true
  }
})

// 查询食堂的菜单历史
const menus = await prisma.menu.findMany({
  where: { canteenId },
  orderBy: { createdAt: 'desc' },
  take: 4
})
```

#### 事务操作
```typescript
// 创建菜单并清理历史记录
const result = await prisma.$transaction(async (tx) => {
  // 创建新菜单
  const newMenu = await tx.menu.create({
    data: { canteenId, weekMenu, generationParams }
  })
  
  // 保留最新4条记录
  const allMenus = await tx.menu.findMany({
    where: { canteenId },
    orderBy: { createdAt: 'desc' }
  })
  
  if (allMenus.length > 4) {
    await tx.menu.deleteMany({
      where: {
        id: { in: allMenus.slice(4).map(m => m.id) }
      }
    })
  }
  
  return newMenu
})
```

### 类型安全

```typescript
// 使用Prisma生成的类型
import type { Canteen, Menu } from '@prisma/client'

// 排除敏感字段的类型
type SafeCanteen = Omit<Canteen, 'password'>

// 菜单关联查询类型
type CanteenWithMenus = Canteen & {
  menus: Menu[]
}
```

---

## 📞 技术支持

### 常见问题

#### Q: 如何重置食堂密码？
A: 
```typescript
const hashedPassword = await bcrypt.hash(newPassword, 12)
await prisma.canteen.update({
  where: { id: canteenId },
  data: { password: hashedPassword }
})
```

#### Q: 如何备份特定食堂数据？
A:
```typescript
const backup = await prisma.canteen.findUnique({
  where: { id: canteenId },
  include: { menus: true }
})
```

#### Q: 如何清理测试数据？
A:
```typescript
// 删除测试食堂（会级联删除相关菜单）
await prisma.canteen.deleteMany({
  where: { canteenName: { startsWith: 'test_' } }
})
```

### 数据库工具

- **可视化管理**：`npx prisma studio`
- **Schema查看**：`npx prisma db pull`
- **数据重置**：`npx prisma migrate reset`

---

\
