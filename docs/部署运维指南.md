# 团餐菜单生成工具 - 部署运维指南

## 📖 概述

本文档面向技术团队，详细说明了团餐菜单生成工具的部署、配置、运维和故障处理。系统基于Next.js构建，支持Vercel快速部署和国内云服务器部署两种方案。

---

## 🏗 技术架构概览

### 技术栈
```
前端：Next.js 15 + React 19 + TypeScript + Ant Design
后端：Next.js API Routes + Prisma ORM
数据库：PostgreSQL (生产) / SQLite (开发)
AI服务：Deepseek Chat API
部署：Vercel (推荐) / 阿里云ECS (备选)
```

### 项目结构
```
ai-menu-040/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── api/               # API路由
│   │   │   ├── auth/          # 认证相关API
│   │   │   ├── generate-menu/ # 菜单生成API
│   │   │   └── history-menus/ # 历史菜单API
│   │   ├── dashboard/         # 主界面
│   │   ├── history/           # 历史记录页面
│   │   └── page.tsx           # 首页
│   ├── components/            # 可复用组件
│   ├── lib/                   # 工具库
│   └── types/                 # TypeScript类型定义
├── prisma/                    # 数据库模式和迁移
├── docs/                      # 文档目录
└── public/                    # 静态资源
```

---

## 🚀 部署方案选择

### 方案一：Vercel 部署（推荐）

**优势：**
- ✅ 零运维成本，完全托管
- ✅ 自动SSL证书和CDN
- ✅ Git集成，自动部署
- ✅ 内置CI/CD和预览环境
- ✅ 全球节点，访问速度快

**成本：**
- 免费版：100GB流量/月，100次构建/月
- Pro版：$20/用户/月（约￥145/月）

**限制：**
- 国内用户可能偶遇访问波动
- 函数执行时间限制（10秒）

### 方案二：国内云服务器部署（备选）

**优势：**
- ✅ 国内访问稳定
- ✅ 更高的控制权和灵活性
- ✅ 可定制化配置

**成本：**
- 阿里云ECS 2核4GB：约￥200-300/月
- 域名：约￥200/年
- 流量费用：按实际使用计费

**运维要求：**
- 需要专业运维人员
- 定期安全更新和备份
- 监控和故障处理

### 🎯 推荐策略

**初期**：使用Vercel免费版
**流量增长后**：升级Vercel Pro版或迁移至阿里云

---

## ⚡ Vercel 快速部署

### 前置要求

1. **GitHub账号**：代码托管
2. **Vercel账号**：deployment platform
3. **Deepseek API Key**：AI服务
4. **数据库**：PostgreSQL实例

### 部署步骤

#### 1. 代码准备

```bash
# 克隆项目（如果还没有）
git clone <your-repo-url>
cd ai-menu-040

# 安装依赖
npm install

# 生成Prisma客户端
npx prisma generate
```

#### 2. 数据库配置

**方案A：使用Vercel Postgres（推荐）**
```bash
# 在Vercel控制台创建PostgreSQL数据库
# 获取DATABASE_URL连接字符串
```

**方案B：使用外部PostgreSQL**
```bash
# 可使用阿里云RDS、AWS RDS等
# 确保网络可访问性
```

#### 3. 环境变量配置

在Vercel项目设置中配置以下环境变量：

```env
# 数据库连接
DATABASE_URL="postgresql://username:password@host:port/database"

# JWT密钥（生产环境必须更换）
NEXTAUTH_SECRET="your-super-secret-jwt-key-production"

# Deepseek API配置
DEEPSEEK_API_KEY="sk-your-deepseek-api-key"

# 环境标识
NODE_ENV="production"

# 应用域名
NEXTAUTH_URL="https://ai-menu.tech"
```

#### 4. 部署执行

```bash
# 方式一：通过Vercel CLI
npm install -g vercel
vercel login
vercel --prod

# 方式二：Git集成部署
git push origin main
# Vercel自动检测到推送并开始部署
```

#### 5. 数据库初始化

```bash
# 部署完成后，在Vercel函数或本地执行
npx prisma db push

# 如果有种子数据
npx prisma db seed
```

### 域名配置

#### 1. 绑定自定义域名

```bash
# 在Vercel项目设置 > Domains
# 添加：ai-menu.tech
# 添加：www.ai-menu.tech (可选)
```

#### 2. DNS配置

在域名提供商处设置：
```
类型: A记录
主机: @
值: 76.76.19.61 (Vercel IP)

类型: CNAME
主机: www
值: 2cf6ce7e3f2d0a3b.vercel-dns-017.com
```

#### 3. SSL证书

Vercel自动提供免费SSL证书，无需额外配置。

---

## 🔧 环境变量详解

### 必需变量

| 变量名 | 说明 | 示例值 | 获取方式 |
|--------|------|--------|----------|
| `DATABASE_URL` | 数据库连接字符串 | `postgresql://user:pass@host:5432/db` | 数据库提供商 |
| `NEXTAUTH_SECRET` | JWT签名密钥 | `random-64-char-string` | 随机生成 |
| `DEEPSEEK_API_KEY` | AI API密钥 | `sk-xxxxxxxxxxxxxxxx` | Deepseek官网申请 |

### 可选变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `NODE_ENV` | 环境标识 | `production` |
| `NEXTAUTH_URL` | 应用完整URL | `https://ai-menu.tech` |

### API Key管理策略

#### 当前使用的API Key
- **位置**：`src/app/api/generate-menu/route.ts:164`
- **调用**：`process.env.DEEPSEEK_API_KEY`
- **成本估算**：
  - 每次菜单生成约消耗 0.01-0.02 USD
  - 月活1000次约消耗 10-20 USD

#### 更换为客户API Key

**步骤：**
1. 客户前往 https://platform.deepseek.com 申请API Key
2. 在Vercel环境变量中替换 `DEEPSEEK_API_KEY`
3. 重新部署应用

**注意事项：**
- 新Key需要有足够的余额
- 确保Key有聊天模型访问权限
- 建议设置使用量监控和告警

---

## 🛡 安全性配置

### API Key安全

```typescript
// 正确做法：使用环境变量
const apiKey = process.env.DEEPSEEK_API_KEY

// 错误做法：硬编码在代码中
const apiKey = "sk-xxxxxxxxxxxxxxxx" // ❌ 不要这样做
```

### 数据库安全

1. **连接加密**：确保DATABASE_URL使用SSL连接
2. **访问控制**：限制数据库访问IP白名单
3. **定期备份**：设置自动备份策略

### 应用安全

1. **HTTPS强制**：Vercel自动启用，无需配置
2. **环境变量保护**：敏感信息不出现在客户端代码中
3. **输入验证**：API路由包含参数验证
4. **会话管理**：JWT token有效期管理

---

## 📊 监控和日志

### Vercel内置监控

**访问监控：**
- 项目Dashboard > Analytics
- 查看访问量、响应时间、错误率

**函数监控：**
- 项目Dashboard > Functions
- 查看函数执行时间、调用次数、错误日志

**实时日志：**
```bash
# 通过Vercel CLI查看实时日志
vercel logs --follow
```

### 自定义监控

#### 关键指标

1. **业务指标**
   - 菜单生成成功率
   - 平均生成时间
   - 用户注册和活跃度

2. **技术指标**
   - API响应时间
   - 数据库连接状态
   - AI API调用成功率

#### 监控代码示例

```typescript
// 在API路由中添加监控
console.log('Menu generation started', {
  canteenId,
  timestamp: new Date().toISOString(),
  params
})

// 记录执行时间
const startTime = Date.now()
// ... 业务逻辑
const endTime = Date.now()
console.log('Menu generation completed', {
  canteenId,
  duration: endTime - startTime,
  success: true
})
```

### 告警设置

**Vercel告警：**
- 项目设置 > Notifications
- 配置部署失败、函数错误等告警

**外部监控：**
- 使用UptimeRobot等服务监控网站可用性
- 设置邮件/短信告警

---

## 💾 数据备份和恢复

### 数据库备份

#### 自动备份（推荐）

**Vercel Postgres：**
- 自动日备份，保留7天
- 自动周备份，保留4周
- 自动月备份，保留12个月

**外部数据库：**
```bash
# PostgreSQL备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="backup_${DATE}.sql"

pg_dump $DATABASE_URL > $BACKUP_FILE
aws s3 cp $BACKUP_FILE s3://your-backup-bucket/
```

#### 手动备份

```bash
# 导出数据库
npx prisma db pull
npx prisma generate

# 导出数据
pg_dump $DATABASE_URL > manual_backup.sql
```

### 恢复操作

```bash
# 从备份恢复
psql $DATABASE_URL < backup_file.sql

# 重新生成Prisma客户端
npx prisma generate
npx prisma db push
```

---

## 🔄 更新和部署流程

### Git工作流

```bash
# 开发分支
git checkout -b feature/new-feature
# 开发和测试
git add .
git commit -m "feat: add new feature"
git push origin feature/new-feature

# 合并到主分支
git checkout main
git merge feature/new-feature
git push origin main
# Vercel自动部署到生产环境
```

### 版本管理

```json
// package.json
{
  "version": "1.0.0",
  "scripts": {
    "release": "npm version patch && git push --tags"
  }
}
```

### 发布检查清单

- [ ] 代码通过所有测试
- [ ] 环境变量配置正确
- [ ] 数据库迁移完成
- [ ] 备份已创建
- [ ] 监控告警已配置
- [ ] 文档已更新

---

## 🐛 故障排除

### 常见问题

#### 1. 部署失败

**现象：** Vercel部署过程中出错
**排查：**
```bash
# 查看构建日志
vercel logs

# 本地测试构建
npm run build
```
**解决：**
- 检查依赖版本兼容性
- 确认环境变量设置
- 查看错误日志定位问题

#### 2. 数据库连接失败

**现象：** 应用无法连接到数据库
**排查：**
```bash
# 测试数据库连接
npx prisma db push --preview-feature
```
**解决：**
- 检查DATABASE_URL格式
- 确认数据库服务状态
- 验证网络连接和防火墙设置

#### 3. AI API调用失败

**现象：** 菜单生成失败
**排查：**
```bash
# 查看API调用日志
vercel logs --since=1h
```
**解决：**
- 检查DEEPSEEK_API_KEY有效性
- 确认API余额充足
- 验证网络连接

#### 4. 用户无法登录

**现象：** 登录失败或会话异常
**排查：**
- 检查NEXTAUTH_SECRET配置
- 查看浏览器网络请求
- 验证数据库用户表数据

### 紧急处理流程

#### 1. 服务不可用

```bash
# 快速回滚到上一个版本
git revert HEAD
git push origin main

# 或使用Vercel控制台回滚
```

#### 2. 数据库问题

```bash
# 切换到备用数据库
# 更新DATABASE_URL环境变量
# 重新部署应用
```

#### 3. API配额耗尽

```bash
# 临时增加API配额
# 或切换到备用API Key
# 更新环境变量
```

---

## 📈 性能优化

### 前端优化

1. **代码分割**：已启用Next.js自动代码分割
2. **图片优化**：使用Next.js Image组件
3. **缓存策略**：静态资源CDN缓存

### 后端优化

1. **数据库连接池**：Prisma自动管理
2. **API响应缓存**：可添加Redis缓存层
3. **异步处理**：菜单生成使用异步API

### 监控指标

- **响应时间**：目标 < 2秒
- **成功率**：目标 > 99%
- **并发处理**：Vercel自动扩容

---

## 🔄 迁移方案

### 从Vercel迁移到阿里云

#### 1. 环境准备

```bash
# 购买阿里云ECS和RDS
# 配置网络和安全组
# 安装Docker和Docker Compose
```

#### 2. 应用迁移

```bash
# 打包应用
docker build -t ai-menu-app .

# 数据库迁移
pg_dump $OLD_DATABASE_URL | psql $NEW_DATABASE_URL

# 启动服务
docker-compose up -d
```

#### 3. 域名切换

```bash
# 更新DNS记录指向新服务器
# 配置Nginx和SSL证书
# 测试完整功能
```

---

## 📞 技术支持

### 常用命令

```bash
# 查看应用状态
vercel ls

# 查看环境变量
vercel env ls

# 查看部署日志
vercel logs

# 重新部署
vercel --prod

# 数据库操作
npx prisma studio
npx prisma db push
npx prisma generate
```

### 联系方式

- **技术负责人**：lyratng(微信)
- **紧急联系**：18810773920

---

## 📋 检查清单

### 部署前检查

- [ ] 代码在本地环境正常运行
- [ ] 所有环境变量已配置
- [ ] 数据库连接测试通过
- [ ] API Key有效且有足够余额
- [ ] 域名DNS已正确配置

### 部署后验证

- [ ] 应用可正常访问
- [ ] 用户注册和登录功能正常
- [ ] 菜单生成功能正常
- [ ] Excel导出功能正常
- [ ] 历史记录查看正常
- [ ] 监控告警已配置

### 运维检查

- [ ] 数据库备份策略已设置
- [ ] 监控指标正常
- [ ] 日志记录完整
- [ ] 安全配置无漏洞
- [ ] 文档已更新

---

*最后更新时间：2025年9月*
*版本号：v1.0*
